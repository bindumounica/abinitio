name: Ab Initio Style ETL â€“ Full CI + Scheduler POC

on:
  # CI trigger
  push:
    branches: [ "main" ]

  # Manual trigger
  # workflow_dispatch:

  # # Scheduler (Control-M equivalent)
  # schedule:
  #   - cron: "30 4 * * *"   # 10:00 AM IST

env:
  COMPONENT_NAME: abinitio-etl-poc
  VERSION: 1.0.0
  IMAGE_NAME: abinitio-etl-poc

jobs:
# =====================================================
# JOB 1: BUILD + PACKAGE ETL COMPONENT
# =====================================================
  build-etl:
    name: Build & Package ETL Component
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Java (Gradle)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Setup Go (Transformation engine)
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 8.7

      # -----------------------------
      # PRE-BUILD VALIDATION
      # -----------------------------
      - name: Pre-build validation
        run: |
          chmod +x ci/pre-build.sh
          ./ci/pre-build.sh

      # -----------------------------
      # RUN REAL ETL LOCALLY (VALIDATION)
      # -----------------------------
      - name: Run ETL pipeline (validation run)
        run: |
          chmod +x runtime/master_pipeline.sh
          ./runtime/master_pipeline.sh

      # -----------------------------
      # BUILD TAR (ETL COMPONENT)
      # -----------------------------
      - name: Build ETL TAR using Gradle
        run: |
          chmod +x gradlew
          ./gradlew clean build

      - name: Verify TAR contents
        run: |
          ls -lh build/dist
          tar -tf build/dist/*.tar

      # -----------------------------
      # POST-BUILD VALIDATION
      # -----------------------------
      - name: Post-build validation & metadata
        env:
          COMPONENT_NAME: abinitio-etl-poc
          VERSION: 1.0.0
        run: |
          chmod +x ci/post-build.sh
          ./ci/post-build.sh

      # -----------------------------
      # UPLOAD TAR ARTIFACT
      # -----------------------------
      - name: Upload ETL TAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: etl-component-tar
          path: build/dist/*.tar
          retention-days: 7

# =====================================================
# JOB 2: BUILD + PUSH DOCKER IMAGE (ARTIFACTORY)
# =====================================================
  dockerize:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: build-etl

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Download ETL TAR artifact
        uses: actions/download-artifact@v4
        with:
          name: etl-component-tar
          path: build/dist

      - name: Verify TAR before image build
        run: |
          ls -lh build/dist
          tar -tf build/dist/*.tar

      # -----------------------------
      # LOGIN TO DOCKER HUB
      # -----------------------------
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -----------------------------
      # BUILD & PUSH IMAGE
      # -----------------------------
      - name: Build Docker Image
        run: |
          docker build \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }} \
            .

      - name: Push Docker Image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}

      - name: Show pushed image
        run: |
          docker images | grep ${{ env.IMAGE_NAME }}

# =====================================================
# JOB 3: SCHEDULED EXECUTION (RUNTIME ONLY)
# =====================================================
  run-etl:
    name: Scheduled ETL Execution
    runs-on: ubuntu-latest
    needs: dockerize

    steps:
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Run ETL Component (Production-like run)
        run: |
          echo "========================================"
          echo "Starting scheduled ETL execution"
          echo "Time: $(date)"
          echo "========================================"

          docker run --rm \
            -e RUN_MODE=PROD \
            -e COMPONENT_NAME=abinitio-etl-poc \
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}

          echo "========================================"
          echo "ETL execution completed"
          echo "========================================"
